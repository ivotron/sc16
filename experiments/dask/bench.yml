# TODO add support for item.repetitions
- name: pull image
  command: docker pull {{ item.image_name }}
- name: pull alpine
  command: docker pull alpine

- name: copy folder into gassyfs
  shell: >
    docker run --rm \
      --volumes-from gassyfs-master \
      -v {{ item.folder_name }}:/data \
      alpine \
        sh -c "cp -r /data/* /mount "
  when: "{{ item.copy_folder | bool }}"
  register: docker_output

- name: write results to output
  shell: echo "{{ item.id }}, copy, gassy, {{docker_output.delta}}" >> results.csv
  when: "{{ item.copy_folder | bool }}"

- name: run benchmark
  command: >
    docker run --rm \
      --volumes-from gassyfs-master \
      {{ item.image_name }} {{ item.image_args }}
  register: docker_output

- name: write results to output
  shell: echo "{{ item.id }}, run, gassy, {{docker_output.delta}}" >> results.csv

- name: delete files
  command: >
    docker run --rm \
      --volumes-from gassyfs-master \
      alpine \
        sh -c "rm -r /mount/* "
  when: "{{ item.copy_folder | bool }}"

# TODO: add execution in tmpfs if needed

- name: run benchmark on localfs
  shell: >
    docker run --rm \
      -v {{ item.folder_name }}:/mount \
      {{ item.image_name }} {{ item.image_args }}
  when: "{{ item.run_in_local_fs | bool }}"
  register: docker_output

- name: write results to output
  shell: echo "{{ item.id }}, run, local, {{docker_output.delta}}" >> results.csv
